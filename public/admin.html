<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel Admin</title>
<style>
  :root{--bg:#0b1220;--panel:#111a2b;--muted:#8aa0c8;--brd:#1c2a46;--acc:#2563eb}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:#e8eefc}
  header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--brd)}
  main{padding:20px;display:grid;gap:20px;grid-template-columns:1fr 1fr}
  .card{background:var(--panel);border:1px solid var(--brd);border-radius:16px;padding:18px}
  h2{margin:0 0 10px}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--brd);background:#0f172a;color:#e8eefc;margin:6px 0}
  button{padding:10px 14px;border-radius:10px;border:0;background:var(--acc);color:#fff;font-weight:600;cursor:pointer}
  small{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid var(--brd);padding:8px;text-align:left;vertical-align:top}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{text-align:right}
  .pill{display:inline-block;background:#0f172a;border:1px solid var(--brd);padding:6px 10px;border-radius:999px}
  .muted{color:var(--muted)}
  img.thumb{max-height:120px;border-radius:10px;border:1px solid var(--brd)}
  .danger{background:#dc2626}
  .ghost{background:transparent;border:1px solid var(--brd)}
  @media(max-width:1100px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="inline">
    <strong>Panel Admin</strong>
    <a class="pill" href="/qr" target="_blank">üì∑ Ver QR</a>
    <a class="pill" href="/status" target="_blank">üìä Estado</a>
  </div>
  <div class="inline">
    <button id="btn-logout" class="ghost">Salir</button>
  </div>
</header>

<main>
  <!-- Textos -->
  <section class="card">
    <h2>Textos del bot</h2>
    <label>Saludo</label>
    <textarea id="tx_greeting" rows="3" placeholder="Hola, soy Samantha‚Ä¶"></textarea>

    <label>Intro de productos</label>
    <input id="tx_productIntro" placeholder="Estos son nuestros planes disponibles en tu pa√≠s:" />

    <label>Opciones de men√∫ (1 por l√≠nea)</label>
    <textarea id="tx_menu" rows="6" placeholder="1. Ver productos‚Ä¶&#10;2. ¬øQu√© es ChatGPT PLUS?&#10;5. Ir a pagar&#10;8. Volver al men√∫"></textarea>

    <div class="inline">
      <button id="btnSaveTexts">Guardar textos</button>
      <small class="muted">El bot usa esto al mostrar el men√∫.</small>
    </div>
  </section>

  <!-- Im√°genes -->
  <section class="card">
    <h2>Im√°genes</h2>
    <div class="row">
      <div>
        <label>Imagen de saludo</label>
        <input type="file" id="fileSaludo" accept="image/*"/>
        <div class="inline">
          <button onclick="uploadSet('saludo','fileSaludo')">Subir y guardar</button>
          <img id="prevSaludo" class="thumb" alt="">
        </div>
      </div>
      <div>
        <label>QR global por defecto</label>
        <input type="file" id="fileQR" accept="image/*"/>
        <div class="inline">
          <button onclick="uploadSet('qr','fileQR')">Subir y guardar</button>
          <img id="prevQR" class="thumb" alt="">
        </div>
      </div>
    </div>

    <hr style="border-color:#1c2a46">
    <label>Referencias (galer√≠a)</label>
    <div class="inline">
      <input type="file" id="fileRef" accept="image/*"/>
      <button onclick="uploadSet('references:add','fileRef')">Agregar</button>
      <button class="danger" onclick="fetch('/api/images',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field:'references:clear'})}).then(loadConfig)">Vaciar</button>
    </div>
    <div id="refsList" class="inline" style="margin-top:10px;"></div>
  </section>

  <!-- Pa√≠ses: b√∫squeda + tabla -->
  <section class="card" style="grid-column:1/-1">
    <h2>Pa√≠ses</h2>
    <div class="inline">
      <input id="searchCountry" placeholder="Buscar (key, nombre o moneda)..." oninput="loadCountries()"/>
      <button onclick="loadCountries()">Buscar</button>
      <button onclick="clearCountryForm();document.getElementById('formCountry').scrollIntoView({behavior:'smooth'})">A√±adir/Editar</button>
    </div>

    <table id="tblCountries">
      <thead>
        <tr><th>Key</th><th>Nombre</th><th>Moneda</th><th>Pagos</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Form pa√≠s -->
  <section id="formCountry" class="card" style="grid-column:1/-1">
    <h2>A√±adir / Editar pa√≠s</h2>
    <div class="row">
      <div>
        <label>Key (ej. peru)</label>
        <input id="c_key" placeholder="min√∫sculas, sin espacios" />
      </div>
      <div>
        <label>Nombre/Label</label>
        <input id="c_label" placeholder="Per√∫" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Moneda (c√≥digo ISO, ej. PEN, ARS, BOB)</label>
        <input id="c_currency" placeholder="PEN" oninput="renderSymbol()" />
      </div>
      <div>
        <label>S√≠mbolo detectado</label>
        <input id="c_symbol" disabled />
      </div>
    </div>

    <div class="row3">
      <div><label>Banco</label><input id="c_bank" /></div>
      <div><label>N¬∞ Cuenta</label><input id="c_account" /></div>
      <div><label>Titular</label><input id="c_owner" /></div>
    </div>

    <div>
      <label>QR de pago (URL o sube archivo)</label>
      <div class="inline">
        <input id="c_qr" placeholder="/media/xxxxx.png o https://..." style="flex:1"/>
        <input type="file" id="fileQRcountry" accept="image/*"/>
        <button onclick="uploadSetInto('fileQRcountry','c_qr')">Subir</button>
      </div>
    </div>

    <h3 style="margin-top:16px">Precios (se mostrar√° con s√≠mbolo)</h3>
    <div class="row">
      <div>
        <label>Compartido 1 (JSON)</label>
        <textarea id="p_shared1" rows="4" placeholder='{"1 mes": 35, "2 meses": 60}'></textarea>
      </div>
      <div>
        <label>Compartido 2 (JSON)</label>
        <textarea id="p_shared2" rows="4" placeholder='{"1 mes": 60, "2 meses": 109}'></textarea>
      </div>
    </div>
    <div>
      <label>Individual (JSON)</label>
      <textarea id="p_individual" rows="4" placeholder='{"1 mes": 139, "2 meses": 269}'></textarea>
    </div>

    <div class="inline" style="margin-top:10px">
      <button onclick="saveCountry()">Guardar pa√≠s</button>
      <button class="danger" onclick="deleteCountry()">Eliminar pa√≠s</button>
    </div>
  </section>
</main>

<script>
  // ===== Helpers =====
  async function api(url, opts={}){
    const r = await fetch(url, opts);
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }
  function textToArray(txt){ return txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
  function arrayToText(arr){ return (arr||[]).join('\n'); }

  // ===== Estado cargado =====
  let CFG = null;

  // ===== Cargar config completa =====
  async function loadConfig(){
    const r = await api('/api/config');
    CFG = r;
    // textos
    document.getElementById('tx_greeting').value = r.texts?.greeting || '';
    document.getElementById('tx_productIntro').value = r.texts?.productIntro || '';
    document.getElementById('tx_menu').value = arrayToText(r.texts?.menu || []);

    // im√°genes preview
    document.getElementById('prevSaludo').src = r.images?.saludo || '';
    document.getElementById('prevQR').src = r.images?.qr || '';

    // referencias
    const refsWrap = document.getElementById('refsList');
    refsWrap.innerHTML = '';
    (r.images?.references || []).forEach(u=>{
      const img = document.createElement('img');
      img.src = u; img.className='thumb';
      refsWrap.appendChild(img);
    });

    // tabla pa√≠ses
    loadCountries();
    renderSymbol();
  }

  // ===== Guardar textos =====
  document.getElementById('btnSaveTexts').onclick = async () => {
    const body = {
      greeting: document.getElementById('tx_greeting').value,
      productIntro: document.getElementById('tx_productIntro').value,
      menu: textToArray(document.getElementById('tx_menu').value)
    };
    await api('/api/texts',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    await loadConfig();
    alert('Textos guardados');
  };

  // ===== Uploads generales (saludo / qr / refs) =====
  async function uploadSet(field, inputId){
    const inp = document.getElementById(inputId);
    if(!inp.files || !inp.files[0]){ alert('Elige un archivo'); return; }
    const fd = new FormData(); fd.append('file', inp.files[0]);
    const up = await fetch('/api/upload',{method:'POST', body:fd}).then(r=>r.json());
    if(!up.ok){ alert('Error subiendo'); return; }
    await fetch('/api/images',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field, value: up.path})});
    await loadConfig();
  }
  async function uploadSetInto(fileInputId, targetInputId){
    const inp = document.getElementById(fileInputId);
    if(!inp.files || !inp.files[0]){ alert('Elige un archivo'); return; }
    const fd = new FormData(); fd.append('file', inp.files[0]);
    const up = await fetch('/api/upload',{method:'POST', body:fd}).then(r=>r.json());
    if(!up.ok){ alert('Error subiendo'); return; }
    document.getElementById(targetInputId).value = up.path;
  }

  // ===== Pa√≠ses: tabla y b√∫squeda =====
  async function loadCountries(){
    const q = document.getElementById('searchCountry').value || '';
    const r = await api('/api/countries'+(q?`?q=${encodeURIComponent(q)}`:''));
    const tb = document.querySelector('#tblCountries tbody');
    tb.innerHTML = '';
    (r.items||[]).forEach(it=>{
      const pay = it.payment || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><code>${it.key}</code></td>
        <td>${it.label||''}</td>
        <td>${it.currency||''}</td>
        <td><small class="muted">${pay.bank||'-'} ‚Ä¢ ${pay.account||'-'} ‚Ä¢ ${pay.owner||'-'}</small></td>
        <td class="inline">
          <button class="ghost" onclick='editCountry(${JSON.stringify(it).replaceAll("'", "\\'")})'>Editar</button>
        </td>`;
      tb.appendChild(tr);
    });
  }

  function clearCountryForm(){
    ['c_key','c_label','c_currency','c_symbol','c_bank','c_account','c_owner','c_qr','p_shared1','p_shared2','p_individual'].forEach(id=>{
      document.getElementById(id).value = '';
    });
  }

  function editCountry(it){
    document.getElementById('c_key').value = it.key || '';
    document.getElementById('c_label').value = it.label || '';
    document.getElementById('c_currency').value = it.currency || '';
    document.getElementById('c_bank').value = it.payment?.bank || '';
    document.getElementById('c_account').value = it.payment?.account || '';
    document.getElementById('c_owner').value = it.payment?.owner || '';
    document.getElementById('c_qr').value = it.payment?.qr || '';
    document.getElementById('p_shared1').value = JSON.stringify(it.prices?.shared1||{}, null, 2);
    document.getElementById('p_shared2').value = JSON.stringify(it.prices?.shared2||{}, null, 2);
    document.getElementById('p_individual').value = JSON.stringify(it.prices?.individual||{}, null, 2);
    renderSymbol();
    document.getElementById('formCountry').scrollIntoView({behavior:'smooth'});
  }

  function renderSymbol(){
    const cur = document.getElementById('c_currency').value.trim().toUpperCase();
    const sym = (CFG?.currencySymbols && CFG.currencySymbols[cur]) || '';
    document.getElementById('c_symbol').value = sym;
  }

  async function saveCountry(){
    const key = document.getElementById('c_key').value.trim().toLowerCase();
    const label = document.getElementById('c_label').value.trim();
    const currency = document.getElementById('c_currency').value.trim().toUpperCase();
    if(!key || !label || !currency){ alert('Key, nombre y moneda son obligatorios'); return; }

    let shared1={}, shared2={}, individual={};
    try{ shared1 = JSON.parse(document.getElementById('p_shared1').value || '{}'); }catch{ alert('JSON inv√°lido en Compartido 1'); return; }
    try{ shared2 = JSON.parse(document.getElementById('p_shared2').value || '{}'); }catch{ alert('JSON inv√°lido en Compartido 2'); return; }
    try{ individual = JSON.parse(document.getElementById('p_individual').value || '{}'); }catch{ alert('JSON inv√°lido en Individual'); return; }

    const body = {
      key, label, currency,
      payment:{
        bank: document.getElementById('c_bank').value,
        account: document.getElementById('c_account').value,
        owner: document.getElementById('c_owner').value,
        qr: document.getElementById('c_qr').value
      },
      prices:{ shared1, shared2, individual }
    };
    await api('/api/countries',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    await loadConfig();
    alert('Pa√≠s guardado');
  }

  async function deleteCountry(){
    const key = document.getElementById('c_key').value.trim().toLowerCase();
    if(!key){ alert('Ingresa la key del pa√≠s a eliminar'); return; }
    if(!confirm('¬øEliminar pa√≠s '+key+'?')) return;
    await api('/api/countries/'+encodeURIComponent(key), { method:'DELETE' });
    await loadConfig();
    clearCountryForm();
    alert('Pa√≠s eliminado');
  }

  // ===== Logout =====
  document.getElementById('btn-logout').onclick = async ()=>{
    await fetch('/api/logout',{method:'POST'});
    location.href = '/login.html';
  };

  // ===== Init =====
  loadConfig().catch(e=>{ alert('No se pudo cargar la configuraci√≥n. ¬øIniciaste sesi√≥n?'); location.href='/login.html'; });
</script>
</body>
</html>